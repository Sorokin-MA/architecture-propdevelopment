# Требования к внешним интеграциям «Умный дом» (домофон/шлагбаум)

## 1. Общие принципы
- **Единая точка входа:** мобильное приложение обращается **только** к API PropDevelopment (через API Gateway). Прямых вызовов к партнёру из приложения нет.
- **Разделение обязанностей:** идентификация пользователей — в IdP PropDevelopment; распознавание лиц/номеров — на стороне партнёра; авторизация доступа (policy) — в PropDevelopment.
- **Минимизация данных:** передаём партнёру только технические идентификаторы и правила доступа. ПДн, биометрию и платежную информацию не передаём.

## 2. Защита транспорта и периметра
- Все внешние интеграции — **TLS 1.2+**; предпочтительно **mTLS** (двусторонняя аутентификация).
- Алловлист IP/подсетей партнёра + WAF/RateLimit/DoS‑профили на шлюзе.
- Обязательная **подпись запросов** (HMAC SHA‑256 с временной меткой, окно ≤5 мин) и защита от повторов (**Idempotency‑Key**).

## 3. Аутентификация и авторизация
- **Пользователи (моб. приложение):** OIDC с **PKCE**; короткоживущие access‑токены (≤10 мин), refresh‑токены — ротируемые.
- **Сервис‑к‑сервису:** OAuth 2.1 **client_credentials** c JWT‑токенами (RS256/ES256), публикация JWKs; альтернатива — **mTLS‑bound tokens**.
- **Маршрутизация прав:** в PropDevelopment заводится объект **AccessPolicy** (зона, дверь/шлагбаум, окна времени, роль). Партнёру выдаётся только «список разрешённых идентификаторов».
- **RBAC/ABAC:** роли «Собственник», «Член семьи», «Гость (временный)», «Оператор УК»; атрибуты — дом/подъезд/квартира, интервал действия пропуска.
- **Привязка биометрии:** биометрические шаблоны **не хранятся** в PropDevelopment. Идентификатор биометрии — внешний `bio_ref` партнёра, связанный с `user_id` PropDevelopment.

## 4. Взаимодействие и протоколы
- **Provisioning** правил доступа: PropDevelopment → Партнёр через REST/gRPC.
- **Команды реального времени:** «открыть», «отклонить» — REST; критичные команды подтверждаются **двухфазно** (202 Accepted → callback).
- **События от партнёра:** webhooks (HTTPS + mTLS) с типами: `FACE_MATCHED`, `PLATE_MATCHED`, `ACCESS_GRANTED`, `ACCESS_DENIED`, `TAMPERING`. Повторяемость — по `Idempotency-Key`.
- **События аудита:** все события пишутся в Event Bus → SIEM. Схема: `timestamp, event_id, user_id, device_id, area_id, decision, confidence, source_ip, trace_id`.
- **Идемпотентность:** действия по управлению доступом и webhooks должны обрабатываться идемпотентно (по `event_id`/`Idempotency-Key`).

## 5. Требования к данным и конфиденциальности
- **Отсутствие биометрии** в контурах PropDevelopment; хранится и обрабатывается у партнёра в его регконтуре.
- **Data minimization:** только `user_id`, `area_id`, `access_policy_id`, `bio_ref/plate_ref`. Личные поля (ФИО, телефон) не требуются партнёру.
- **Ретенция логов:** события доступа — ≥ 12 мес (уточнить внутренний стандарт), с неизменяемым хранилищем (WORM/строгая целостность).
- **Согласия и уведомление:** хранить юридически значимое согласие пользователя на использование биометрии; предоставлять отзыв согласия → автоматический отзыв `bio_ref` у партнёра.
- **Локализация хранения:** ПДн и платёжные данные — в контурах PropDevelopment/PCI; партнёру не передаются.

## 6. Наличие зон и сред
- Отдельный интеграционный сегмент сети; доступ от API Gateway к партнёру — через egress‑контроллер.
- Секреты интеграции — в KMS/Secrets Manager; ключи ротируются (≤90 дней), есть break‑glass‑процедуры.

## 7. Нефункциональные требования
- Доступность интеграции ≥ 99.9%; таймауты < 3 с на команду; повтор отправки с экспоненциальной задержкой (до 3 попыток).
- Нагрузочные профили: пиковая пропускная способность webhooks — N событий/минуту на дом/ЖК (заполнить по ТЗ партнёра).
- Наблюдаемость: трассировка (trace_id), метрики (p95 latency, error rate), алерты (SLO).

## 8. Тестирование и приёмка
- Контур песочницы, тестовые устройства; контракт‑тесты (OpenAPI), проверка подписи, mTLS, идемпотентности и повторов.
- Таблица совместимости версий API; политика депрекейта: не менее 6 месяцев параллельной поддержки.